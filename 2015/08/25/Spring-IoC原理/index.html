<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Spring,IoC," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="#控制反转IoC（Inverse of Control）与依赖注入DI（Dependency Injection）#依赖注入和控制反转是对同一件事情的不同描述，从某个方面讲，就是它们描述的角度不同。依赖注入是从应用程序的角度在描述，可以把依赖注入描述完整点：应用程序依赖容器创建并注入它所需要的外部资源；而控制反转是从容器的角度在描述，描述完整点：容器控制应用程序，由容器反向的向应用程序注入应用程序">
<meta name="keywords" content="Spring,IoC">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring IoC原理">
<meta property="og:url" content="http://jeffzzf.github.io/2015/08/25/Spring-IoC原理/index.html">
<meta property="og:site_name" content="Noob">
<meta property="og:description" content="#控制反转IoC（Inverse of Control）与依赖注入DI（Dependency Injection）#依赖注入和控制反转是对同一件事情的不同描述，从某个方面讲，就是它们描述的角度不同。依赖注入是从应用程序的角度在描述，可以把依赖注入描述完整点：应用程序依赖容器创建并注入它所需要的外部资源；而控制反转是从容器的角度在描述，描述完整点：容器控制应用程序，由容器反向的向应用程序注入应用程序">
<meta property="og:image" content="http://wenku.baidu.com/content/0d98c54eaaea998fcc220eb5?m=c2e257654169124c4b0c9d6e45c3adff&type=pic&src=ec5dc1203cb8cbe498304957b825d4ec.jpg">
<meta property="og:updated_time" content="2016-04-20T11:22:04.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring IoC原理">
<meta name="twitter:description" content="#控制反转IoC（Inverse of Control）与依赖注入DI（Dependency Injection）#依赖注入和控制反转是对同一件事情的不同描述，从某个方面讲，就是它们描述的角度不同。依赖注入是从应用程序的角度在描述，可以把依赖注入描述完整点：应用程序依赖容器创建并注入它所需要的外部资源；而控制反转是从容器的角度在描述，描述完整点：容器控制应用程序，由容器反向的向应用程序注入应用程序">
<meta name="twitter:image" content="http://wenku.baidu.com/content/0d98c54eaaea998fcc220eb5?m=c2e257654169124c4b0c9d6e45c3adff&type=pic&src=ec5dc1203cb8cbe498304957b825d4ec.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://jeffzzf.github.io/2015/08/25/Spring-IoC原理/"/>





  <title> Spring IoC原理 | Noob </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Noob</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://jeffzzf.github.io/2015/08/25/Spring-IoC原理/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Jeffzzf">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Noob">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Noob" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Spring IoC原理
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-08-25T17:21:48+08:00">
                2015-08-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java-Web/" itemprop="url" rel="index">
                    <span itemprop="name">Java Web</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java-Web/Spring/" itemprop="url" rel="index">
                    <span itemprop="name">Spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>#控制反转IoC（Inverse of Control）与依赖注入DI（Dependency Injection）#<br>依赖注入和控制反转是对同一件事情的不同描述，从某个方面讲，就是它们描述的角度不同。依赖注入是从应用程序的角度在描述，可以把依赖注入描述完整点：应用程序依赖容器创建并注入它所需要的外部资源；而控制反转是从容器的角度在描述，描述完整点：容器控制应用程序，由容器反向的向应用程序注入应用程序所需要的外部资源。</p>
<p>其实IoC/DI对编程带来的最大改变不是从代码上，而是从思想上，发生了“主从换位”的变化。应用程序原本是老大，要获取什么资源都是主动出击，但是在IoC/DI思想中，应用程序就变成被动的了，被动的等待IoC/DI容器来创建并注入它所需要的资源了。</p>
<p>这么小小的一个改变其实是编程思想的一个大进步，这样就有效的分离了对象和它所需要的外部资源，使得它们松散耦合，有利于功能复用，更重要的是使得程序的整个体系结构变得非常灵活。</p>
<p>#BeanFactory与ApplicationContext#<br>Spring IoC有两个主要的容器系列：</p>
<ol>
<li>实现BeanFactory接口的简单容器系列，这一系列容器只实现了容器的最基本功能</li>
<li>ApplicationContext应用上下文，它作为容器的高级形态存在。应用上下文在简单容器的基础上，增加了许多面向框架的特性，同时对应用环境做了许多适配</li>
</ol>
<p><strong>BeanFactory</strong>是IoC容器体系结构中最基本的接口类<br><strong>BeanDefinition</strong>是对依赖反转模式中管理对象依赖关系的数据抽象，也是容器实现依赖反转功能的核心数据结构<br><img src="http://wenku.baidu.com/content/0d98c54eaaea998fcc220eb5?m=c2e257654169124c4b0c9d6e45c3adff&amp;type=pic&amp;src=ec5dc1203cb8cbe498304957b825d4ec.jpg" alt="此处输入图片的描述"></p>
<ul>
<li>BeanFactory接口定义了基本的IoC容器的规范，包含了getBean()这样的IoC容器的基本方法（通过这个方法可以从容器中取得Bean）。HierarchicalBeanFactory接口继承了BeanFactory接口之后，增加了getParentFactory()接口功能，使BeanFactory具备了双亲IoC管理的功能。在ConfigurableBeanFactory接口中，定义了一些对BeanFactory的配置功能，比如通过setParentBeanFactory()设置双亲IoC容器，通过addBeanPostProcessor()配置bean后置处理器等等。通过这些接口设计的叠加，定义了BeanFactory就是简单IoC容器的基本功能。</li>
<li>在ApplicationContext设计中，一方面它继承了BeanFactory接口体系中的ListableBeanFactor、HierachicalBeanFactory等BeanFactory的接口，具备了BeanFactory IoC的基本功能（并未继承AutowireCapableBeanFactory接口，因为几乎不会被程序用到，但是可以通过ApplicationContext的getAutowireCapableBeanFactory()获得）；另一方面，通过继承MessageSource、ResourceLoader、ApplicationEventPublisher这些接口，为ApplicationContext赋予更高级的IoC容器特性。</li>
</ul>
<p>#BeanFactory容器设计原理（以XmlBeanFactory为例）#<br>DefaultListableBeanFactory包含了基本IoC容器的重要功能，是很多地方被用到的容器系列中的基本产品，Spring实际把DefaultListableBeanFactory作为默认的功能完整的IoC容器来使用。XmlBeanFactory继承了DefaultListableBeanFactory容器功能的同时，可以读取以XML文件定义的BeanDefinition。</p>
<p>XmlBeanFactory初始化了一个XmlBeanDefinitionReader的对象，由这个Reader对象从Xml文件中读取BeanDefinition信息。</p>
<p>构造XmlBeanFactory容器时，需要指定BeanDefinition信息的来源，这个来源由封装成Spring Resource的对象提供。Resource是Spring用来封装I/O操作的类。</p>
<p>#ApplicationContext新特性#<br>ApplicationContext提供了BeanFactory不具备的新特性，这些新特性使得对ApplicationContext的使用是一种面向框架的使用风格，一般建议在开发时使用ApplicationContext作为IoC容器的基本形式。ApplicationContext的新特性包括：</p>
<ol>
<li>支持不同的信息源，通过扩展MessageSource接口支持国际化的实现，为开发多语言版本的应用提供服务。</li>
<li>访问资源，可以从不同地方得到Bean定义资源</li>
<li>支持应用事件，继承接口ApplicationEventPublisher，从而在上下文引入事件机制。这些事件和Bean生命周期的结合为Bean管理提供便利。</li>
</ol>
<p>#ApplicationContext设计原理（以FileSystemXmlApplicationContext为例）#<br>FileSystemXmlApplicationContext的主要功能在基类AbstractXmlApplicationContext中实现，作为一个具体的应用上下文，只需要实现和它自身设计相关的两个功能。</p>
<ol>
<li>启动IoC容器的refresh()过程，该过程涉及IoC容器启动的一系列复杂操作。</li>
<li>提供getResourceByPath()，得到FileSystemResource的资源定位。</li>
</ol>
<p>#IoC容器初始化过程#</p>
<ol>
<li>Resource定位过程。定位BeanDefinition的资源定位，它由ResourceLoader通过统一的Resource接口完成。BeanDefinition资源定位的过程是由refresh触发的。</li>
<li>BeanDefinition的载入。把用户定义好的Bean表示成IoC容器内部的数据结构，容器内部Bean的数据结构就是BeanDefinition。</li>
<li>向IoC容器注册BeanDefinition。这个过程通过调用BeanDefinitionRegistry接口实现的。IoC容器通过HashMap来管理BeanName和BeanDefinition。Bean和对应的BeanDefinition都是在beanDefinitionMap中被检索和使用，容器的作用就是对这些信息进行处理和维护，这些信息时容器建立依赖反转的基础。</li>
</ol>
<blockquote>
<p>IoC初始化过程一般不包含Bean依赖注入的实现。Spring IoC中，Bean定义的载入和依赖注入是两个独立的过程。依赖注入一般发生在应用第一次通过getBean向容器索取Bean的时候。但是如果对某个Bean设置lazyinit属性， 那么这个Bean的依赖注入在IoC容器初始化时就预先完成了，而不需要等到整个初始化完成以后，第一次使用getBean时才触发。</p>
</blockquote>
<p>#IoC容器依赖注入的过程#<br>IoC容器经过初始化建立Bean和BeanDefinition之间的映射关系之后，用户通过getBean索要Bean时触发依赖注入过程（如果配置了lazy-init，则依赖注入发生在初始化过程中）。</p>
<p>依赖注入的过程发生在DefaultListableBeanFactory的基类AbstractBeanFactory的doGetBean函数中。处理依赖注入的过程为：</p>
<ol>
<li>尝试从缓存中获取Bean，对于已经被创建的Singleton Bean，直接获取而不需要重复创建。</li>
<li>如果当前IoC容器中没有找到相应的Bean，则到双亲IoC容器中向上递归查找Bean</li>
<li>获取当前Bean依赖的所有Bean，递归进行查找和依赖注入的过程，直到没有依赖的Bean（DFS）</li>
<li>创建Singleton、prototype 类型实例</li>
<li>对创建的Bean进行类型检查，如果没有问题，就返回这个新创建的Bean，这个Bean已经是包含依赖关系的Bean</li>
</ol>
<p>#createBean过程#</p>
<ol>
<li>检查需要创建的Bean是否可以实例化，这个类是否可以通过类装载器载入.</li>
<li>如果Bean定义的单态模式(Singleton)，则容器在创建之前先从缓存中查找，以确保整个容器中只存在一个实例对象。如果Bean定义的是原型模式(Prototype)，则容器每次都会创建一个新的实例对象。除此之外，Bean定义还可以扩展为指定其生命周期范围。具体的Bean实例对象的创建过程由实现了ObejctFactory接口的匿名内部类的createBean方法完成，ObejctFactory使用委派模式，具体的Bean实例创建过程交由其实现类AbstractAutowireCapableBeanFactory完成。</li>
<li>生成Bean的方法有多种，可以通过工厂方法生成，也可以通过容器的autowire特性生成，这些生成方式都是由相关的BeanDefinition决定的。</li>
<li>如果Bean有方法被覆盖了，则使用JDK的反射机制进行实例化，否则，使用CGLIB进行实例化。instantiateWithMethodInjection方法调用SimpleInstantiationStrategy的子类CglibSubclassingInstantiationStrategy使用CGLIB来进行初始化。</li>
</ol>
<p>#依赖注入#</p>
<ol>
<li>对于集合类型的属性，将其属性值解析为目标类型的集合后直接赋值给属性。</li>
<li>对于非集合类型的属性，大量使用了JDK的反射和内省机制，通过属性的getter方法(reader method)获取指定属性注入以前的值，同时调用属性的setter方法(writer method)为属性设置注入后的值。</li>
</ol>
<p>至此Spring IoC容器对Bean定义资源文件的定位，载入、解析和依赖注入已经全部分析完毕，现在Spring IoC容器中管理了一系列靠依赖关系联系起来的Bean，程序不需要应用自己手动创建所需的对象，Spring IoC容器会在我们使用的时候自动为我们创建，并且为我们注入好相关的依赖，这就是Spring核心功能的控制反转和依赖注入的相关功能。</p>
<p>#Beanfactory 和 FactoryBean#<br>BeanFactory 指的是 IOC 容器的编程抽象，比如 ApplicationContext， XmlBeanFactory 等，这些都是IOC 容器的具体表现，需要使用什么样的容器由客户决定, Spring 为我们提供了丰富的选择。 FactoryBean 是一个可以在 IOC而容器中被管理的一个 bean,是对各种处理过程和资源使用的抽象,FactoryBean 在需要时产生另一个对象，而不返回 FactoryBean本身,我们可以把它看成是一个抽象工厂，对它的调用返回的是工厂生产的产品。所有的 Factory bean 都实现特殊的org.springframework.beans.factory.FactoryBean 接口，当使用容器中 factory bean 的时候，该容器不会返回 factory bean 本身,而是返回其生成的对象。</p>
<p>Spring 包括了大部分的通用资源和服务访问抽象的 Factory bean 的实现，其中包括:对 JNDI 查询的处理，对代理对象的处理，对事务性代理的处理，对 RMI 代理的处理等，这些我们都可以看成是具体的工厂,看成是SPRING 为我们建立好的工厂。也就是说 Spring 通过使用抽象工厂模式为我们准备了一系列工厂来生产一些特定的对象,免除我们手工重复的工作，我们要使用时只需要在 IOC 容器里配置好就能很方便的使用了。</p>
<p>#参考资料#</p>
<ol>
<li>《Spring技术内幕（第二版）》</li>
<li><a href="http://www.cnblogs.com/ITtangtang/p/3978349.html" target="_blank" rel="external">Spring：源码解读Spring IOC原理</a></li>
<li><a href="http://www.cnblogs.com/jqyp/archive/2010/08/20/1805041.html" target="_blank" rel="external">java动态代理（JDK和cglib）
</a></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Spring/" rel="tag"># Spring</a>
          
            <a href="/tags/IoC/" rel="tag"># IoC</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/08/26/Spring-AOP原理/" rel="next" title="Spring AOP原理">
                <i class="fa fa-chevron-left"></i> Spring AOP原理
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/08/25/RTTI、反射/" rel="prev" title="RTTI、反射">
                RTTI、反射 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Jeffzzf" />
          <p class="site-author-name" itemprop="name">Jeffzzf</p>
          <p class="site-description motion-element" itemprop="description">Do one thing at a time, and do well.</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">79</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">42</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">81</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jeffzzf</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid="></script>
      <!-- UY END -->
  




  
  

  

  

  

  


</body>
</html>
